# Progress Log — 2025-12-25

This document captures the work completed on **Dec 25, 2025** in the `opendata/` repo and its `skyrate-ai/` submodule. It is written to be a durable “what changed / why / how to use it” reference.

## Executive summary

The SkyRate AI Streamlit app gained:

1. **BEN-wide bundling (strict match)**
   - Selecting one application can expand into a bundle of *all* applications matching **BEN + Funding Year**.
   - Bundle reporting persists across reruns.

2. **Hybrid persistence for AI outputs**
   - AI outputs are persisted to **SQLite**.
   - Readable HTML snapshots are also written to disk for long-term, human-friendly viewing.

3. **Bundle-level executive summary (LLM-generated)**
   - A bundle can store a persisted Markdown “Executive summary”.
   - Summary is shown at the top of the bundle UI and can be embedded into the saved bundle HTML.
   - Summary can be auto-generated on save.

4. **“Readable report view” is now the default**
   - The most readable HTML rendering is used as the primary/default analysis display.
   - The old inline markdown view is still available as an optional “legacy view”.

5. **Open saved reports in a new tab**
   - Bundle report viewer: `?view=bundle&bundle_key=...`
   - Case report viewer: `?view=case&analysis_key=...`

6. **Reliable launch scripts**
   - Added repo-root launcher scripts for Windows:
     - `start_skyrate_ai.ps1`
     - `start_skyrate_ai.bat`

## Key UX behavior changes

### Default rendering

- The default analysis display is now the **Readable report view (recommended)**.
- The previous inline “AI Analysis & Insights” rendering is **hidden by default** and can be toggled on via:
  - “Show legacy inline view (less readable)”

### Automatic HTML snapshot creation

- When an analysis is displayed, the app can auto-create a persisted HTML snapshot (toggle defaults to **on**):
  - “Auto-create HTML snapshot (recommended)”
- Snapshots are:
  - stored in the DB (for in-app retrieval), and
  - written to disk (for durability + easy download).

### Open in new tab

- Per-case (per application) report has a new tab link:
  - `?view=case&analysis_key=<analysis_key>`
- Bundle report has a new tab link:
  - `?view=bundle&bundle_key=<bundle_key>`

This avoids the limitation where local `C:\...` paths can’t be reliably opened as links in the browser.

## Persistence: what is stored

Within `skyrate-ai/utils/workspace.py`:

### Per-application analysis storage

A dedicated per-application table is used to prevent overwrites when multiple applications share the same BEN/year.

- Keying uses a computed `analysis_key` built from:
  - `ben`
  - `funding_year`
  - `application_number` and/or `frn`
  - optional extra fields

Stored artifacts include:
- `analysis_text`
- contact enrichment / NCES data JSON
- denied/appeals artifacts (`denial_details`, `appeal_strategy`, `appeal_analysis_text`)
- per-case readable HTML snapshot (`case_report_html`, `case_report_path`)

### BEN bundle storage

A bundle table stores BEN-wide artifacts:
- `bundle_html`, `bundle_path` (persisted readable bundle report)
- `bundle_summary_md`, `bundle_summary_model` (executive summary)

## LLM routing / models (what powers what)

The application routes tasks to different models (when API keys are available). At time of writing, the routing in `skyrate-ai/utils/ai_models.py` is:

- **Query interpretation / quick answers** → DeepSeek
- **Deep analysis / strategic planning** → Gemini
- **Report generation (readable summaries)** → Claude
- **Debate simulation** → Claude (implemented, but not used by default in the bundle flow)

## How to run

### Option A: From repo root (recommended on Windows)

- PowerShell:
  - Run `start_skyrate_ai.ps1`
- CMD:
  - Run `start_skyrate_ai.bat`

Both scripts start Streamlit pointing to `skyrate-ai/app.py` and default to port `8502` (override with `SKYRATE_PORT`).

### Option B: Manual

From repo root:

- `cd skyrate-ai`
- `pip install -r requirements.txt`
- `streamlit run app.py`

## Notes

- Streamlit keeps the server process running; the terminal will not “exit” unless you stop the app.
- If port 8501/8502 is busy, choose another port or stop the prior Streamlit process.

---

Last updated: 2025-12-25
